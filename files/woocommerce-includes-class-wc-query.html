<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1692866947">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1692866947">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/woocommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/woocommerce-admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/automattic-woocommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-Classes.html"><abbr title="\WooCommerce\Classes">Classes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Abstracts.html"><abbr title="\WooCommerce\Abstracts">Abstracts</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Helper.html"><abbr title="\WooCommerce\Helper">Helper</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Views.html"><abbr title="\WooCommerce\Views">Views</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Templates.html"><abbr title="\WooCommerce\Templates">Templates</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Reports.html"><abbr title="\WooCommerce\Reports">Reports</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Blocks.html"><abbr title="\WooCommerce\Blocks">Blocks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-RestApi.html"><abbr title="\WooCommerce\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-CLI.html"><abbr title="\WooCommerce\CLI">CLI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-l10n.html"><abbr title="\WooCommerce\l10n">l10n</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Webhooks.html"><abbr title="\WooCommerce\Webhooks">Webhooks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-DataStores.html"><abbr title="\WooCommerce\DataStores">DataStores</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Emails.html"><abbr title="\WooCommerce\Emails">Emails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Export.html"><abbr title="\WooCommerce\Export">Export</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Gateways.html"><abbr title="\WooCommerce\Gateways">Gateways</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PayPal.html"><abbr title="\WooCommerce\PayPal">PayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Import.html"><abbr title="\WooCommerce\Import">Import</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Integrations.html"><abbr title="\WooCommerce\Integrations">Integrations</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interfaces.html"><abbr title="\WooCommerce\Interfaces">Interfaces</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interface.html"><abbr title="\WooCommerce\Interface">Interface</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-LogHandlers.html"><abbr title="\WooCommerce\LogHandlers">LogHandlers</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PaymentTokens.html"><abbr title="\WooCommerce\PaymentTokens">PaymentTokens</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Utilities.html"><abbr title="\WooCommerce\Utilities">Utilities</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shipping.html"><abbr title="\WooCommerce\Shipping">Shipping</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shortcodes.html"><abbr title="\WooCommerce\Shortcodes">Shortcodes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Tracks.html"><abbr title="\WooCommerce\Tracks">Tracks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Traits.html"><abbr title="\WooCommerce\Traits">Traits</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Functions.html"><abbr title="\WooCommerce\Functions">Functions</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCom.html"><abbr title="\WooCommerce\WCCom">WCCom</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCOM.html"><abbr title="\WooCommerce\WCCOM">WCCOM</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Widgets.html"><abbr title="\WooCommerce\Widgets">Widgets</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Uninstaller.html"><abbr title="\WooCommerce\Uninstaller">Uninstaller</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceAdmin.html"><abbr title="\WoocommerceAdmin">WoocommerceAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceNavigation.html"><abbr title="\WoocommerceNavigation">WoocommerceNavigation</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/Automattic-WooCommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wc-query.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Contains the query functions for WooCommerce which alter the front-end post queries and loops
 *
 * @version 3.2.0
 * @package WooCommerce\Classes
 */

use Automattic\WooCommerce\Internal\ProductAttributesLookup\Filterer;
use Automattic\WooCommerce\Internal\Traits\AccessiblePrivateMethods;

defined( &#039;ABSPATH&#039; ) || exit;

/**
 * WC_Query Class.
 */
class WC_Query {

	use AccessiblePrivateMethods;

	/**
	 * Query vars to add to wp.
	 *
	 * @var array
	 */
	public $query_vars = array();

	/**
	 * Reference to the main product query on the page.
	 *
	 * @var WP_Query
	 */
	private static $product_query;

	/**
	 * Stores chosen attributes.
	 *
	 * @var array
	 */
	private static $chosen_attributes;

	/**
	 * The instance of the class that helps filtering with the product attributes lookup table.
	 *
	 * @var Filterer
	 */
	private $filterer;

	/**
	 * Constructor for the query class. Hooks in methods.
	 */
	public function __construct() {
		$this-&gt;filterer = wc_get_container()-&gt;get( Filterer::class );

		add_action( &#039;init&#039;, array( $this, &#039;add_endpoints&#039; ) );
		if ( ! is_admin() ) {
			add_action( &#039;wp_loaded&#039;, array( $this, &#039;get_errors&#039; ), 20 );
			add_filter( &#039;query_vars&#039;, array( $this, &#039;add_query_vars&#039; ), 0 );
			add_action( &#039;parse_request&#039;, array( $this, &#039;parse_request&#039; ), 0 );
			add_action( &#039;pre_get_posts&#039;, array( $this, &#039;pre_get_posts&#039; ) );
			add_filter( &#039;get_pagenum_link&#039;, array( $this, &#039;remove_add_to_cart_pagination&#039; ), 10, 1 );
		}
		$this-&gt;init_query_vars();
	}

	/**
	 * Reset the chosen attributes so that get_layered_nav_chosen_attributes will get them from the query again.
	 */
	public static function reset_chosen_attributes() {
		self::$chosen_attributes = null;
	}

	/**
	 * Get any errors from querystring.
	 */
	public function get_errors() {
		// phpcs:ignore WordPress.Security.NonceVerification.Recommended
		$error = ! empty( $_GET[&#039;wc_error&#039;] ) ? sanitize_text_field( wp_unslash( $_GET[&#039;wc_error&#039;] ) ) : &#039;&#039;;

		if ( $error &amp;&amp; ! wc_has_notice( $error, &#039;error&#039; ) ) {
			wc_add_notice( $error, &#039;error&#039; );
		}
	}

	/**
	 * Init query vars by loading options.
	 */
	public function init_query_vars() {
		// Query vars to add to WP.
		$this-&gt;query_vars = array(
			// Checkout actions.
			&#039;order-pay&#039;                  =&gt; get_option( &#039;woocommerce_checkout_pay_endpoint&#039;, &#039;order-pay&#039; ),
			&#039;order-received&#039;             =&gt; get_option( &#039;woocommerce_checkout_order_received_endpoint&#039;, &#039;order-received&#039; ),
			// My account actions.
			&#039;orders&#039;                     =&gt; get_option( &#039;woocommerce_myaccount_orders_endpoint&#039;, &#039;orders&#039; ),
			&#039;view-order&#039;                 =&gt; get_option( &#039;woocommerce_myaccount_view_order_endpoint&#039;, &#039;view-order&#039; ),
			&#039;downloads&#039;                  =&gt; get_option( &#039;woocommerce_myaccount_downloads_endpoint&#039;, &#039;downloads&#039; ),
			&#039;edit-account&#039;               =&gt; get_option( &#039;woocommerce_myaccount_edit_account_endpoint&#039;, &#039;edit-account&#039; ),
			&#039;edit-address&#039;               =&gt; get_option( &#039;woocommerce_myaccount_edit_address_endpoint&#039;, &#039;edit-address&#039; ),
			&#039;payment-methods&#039;            =&gt; get_option( &#039;woocommerce_myaccount_payment_methods_endpoint&#039;, &#039;payment-methods&#039; ),
			&#039;lost-password&#039;              =&gt; get_option( &#039;woocommerce_myaccount_lost_password_endpoint&#039;, &#039;lost-password&#039; ),
			&#039;customer-logout&#039;            =&gt; get_option( &#039;woocommerce_logout_endpoint&#039;, &#039;customer-logout&#039; ),
			&#039;add-payment-method&#039;         =&gt; get_option( &#039;woocommerce_myaccount_add_payment_method_endpoint&#039;, &#039;add-payment-method&#039; ),
			&#039;delete-payment-method&#039;      =&gt; get_option( &#039;woocommerce_myaccount_delete_payment_method_endpoint&#039;, &#039;delete-payment-method&#039; ),
			&#039;set-default-payment-method&#039; =&gt; get_option( &#039;woocommerce_myaccount_set_default_payment_method_endpoint&#039;, &#039;set-default-payment-method&#039; ),
		);
	}

	/**
	 * Get page title for an endpoint.
	 *
	 * @param string $endpoint Endpoint key.
	 * @param string $action Optional action or variation within the endpoint.
	 *
	 * @since 2.3.0
	 * @since 4.6.0 Added $action parameter.
	 * @return string The page title.
	 */
	public function get_endpoint_title( $endpoint, $action = &#039;&#039; ) {
		global $wp;

		switch ( $endpoint ) {
			case &#039;order-pay&#039;:
				$title = __( &#039;Pay for order&#039;, &#039;woocommerce&#039; );
				break;
			case &#039;order-received&#039;:
				$title = __( &#039;Order received&#039;, &#039;woocommerce&#039; );
				break;
			case &#039;orders&#039;:
				if ( ! empty( $wp-&gt;query_vars[&#039;orders&#039;] ) ) {
					/* translators: %s: page */
					$title = sprintf( __( &#039;Orders (page %d)&#039;, &#039;woocommerce&#039; ), intval( $wp-&gt;query_vars[&#039;orders&#039;] ) );
				} else {
					$title = __( &#039;Orders&#039;, &#039;woocommerce&#039; );
				}
				break;
			case &#039;view-order&#039;:
				$order = wc_get_order( $wp-&gt;query_vars[&#039;view-order&#039;] );
				/* translators: %s: order number */
				$title = ( $order ) ? sprintf( __( &#039;Order #%s&#039;, &#039;woocommerce&#039; ), $order-&gt;get_order_number() ) : &#039;&#039;;
				break;
			case &#039;downloads&#039;:
				$title = __( &#039;Downloads&#039;, &#039;woocommerce&#039; );
				break;
			case &#039;edit-account&#039;:
				$title = __( &#039;Account details&#039;, &#039;woocommerce&#039; );
				break;
			case &#039;edit-address&#039;:
				$title = __( &#039;Addresses&#039;, &#039;woocommerce&#039; );
				break;
			case &#039;payment-methods&#039;:
				$title = __( &#039;Payment methods&#039;, &#039;woocommerce&#039; );
				break;
			case &#039;add-payment-method&#039;:
				$title = __( &#039;Add payment method&#039;, &#039;woocommerce&#039; );
				break;
			case &#039;lost-password&#039;:
				if ( in_array( $action, array( &#039;rp&#039;, &#039;resetpass&#039;, &#039;newaccount&#039; ), true ) ) {
					$title = __( &#039;Set password&#039;, &#039;woocommerce&#039; );
				} else {
					$title = __( &#039;Lost password&#039;, &#039;woocommerce&#039; );
				}
				break;
			default:
				$title = &#039;&#039;;
				break;
		}

		/**
		 * Filters the page title used for my-account endpoints.
		 *
		 * @since 2.6.0
		 * @since 4.6.0 Added $action parameter.
		 *
		 * @see get_endpoint_title()
		 *
		 * @param string $title Default title.
		 * @param string $endpoint Endpoint key.
		 * @param string $action Optional action or variation within the endpoint.
		 */
		return apply_filters( &#039;woocommerce_endpoint_&#039; . $endpoint . &#039;_title&#039;, $title, $endpoint, $action );
	}

	/**
	 * Endpoint mask describing the places the endpoint should be added.
	 *
	 * @since 2.6.2
	 * @return int
	 */
	public function get_endpoints_mask() {
		if ( &#039;page&#039; === get_option( &#039;show_on_front&#039; ) ) {
			$page_on_front     = get_option( &#039;page_on_front&#039; );
			$myaccount_page_id = get_option( &#039;woocommerce_myaccount_page_id&#039; );
			$checkout_page_id  = get_option( &#039;woocommerce_checkout_page_id&#039; );

			if ( in_array( $page_on_front, array( $myaccount_page_id, $checkout_page_id ), true ) ) {
				return EP_ROOT | EP_PAGES;
			}
		}

		return EP_PAGES;
	}

	/**
	 * Add endpoints for query vars.
	 */
	public function add_endpoints() {
		$mask = $this-&gt;get_endpoints_mask();

		foreach ( $this-&gt;get_query_vars() as $key =&gt; $var ) {
			if ( ! empty( $var ) ) {
				add_rewrite_endpoint( $var, $mask );
			}
		}
	}

	/**
	 * Add query vars.
	 *
	 * @param array $vars Query vars.
	 * @return array
	 */
	public function add_query_vars( $vars ) {
		foreach ( $this-&gt;get_query_vars() as $key =&gt; $var ) {
			$vars[] = $key;
		}
		return $vars;
	}

	/**
	 * Get query vars.
	 *
	 * @return array
	 */
	public function get_query_vars() {
		return apply_filters( &#039;woocommerce_get_query_vars&#039;, $this-&gt;query_vars );
	}

	/**
	 * Get query current active query var.
	 *
	 * @return string
	 */
	public function get_current_endpoint() {
		global $wp;

		foreach ( $this-&gt;get_query_vars() as $key =&gt; $value ) {
			if ( isset( $wp-&gt;query_vars[ $key ] ) ) {
				return $key;
			}
		}
		return &#039;&#039;;
	}

	/**
	 * Parse the request and look for query vars - endpoints may not be supported.
	 */
	public function parse_request() {
		global $wp;

		// phpcs:disable WordPress.Security.NonceVerification.Recommended
		// Map query vars to their keys, or get them if endpoints are not supported.
		foreach ( $this-&gt;get_query_vars() as $key =&gt; $var ) {
			if ( isset( $_GET[ $var ] ) ) {
				$wp-&gt;query_vars[ $key ] = sanitize_text_field( wp_unslash( $_GET[ $var ] ) );
			} elseif ( isset( $wp-&gt;query_vars[ $var ] ) ) {
				$wp-&gt;query_vars[ $key ] = $wp-&gt;query_vars[ $var ];
			}
		}
		// phpcs:enable WordPress.Security.NonceVerification.Recommended
	}

	/**
	 * Are we currently on the front page?
	 *
	 * @param WP_Query $q Query instance.
	 * @return bool
	 */
	private function is_showing_page_on_front( $q ) {
		return ( $q-&gt;is_home() &amp;&amp; ! $q-&gt;is_posts_page ) &amp;&amp; &#039;page&#039; === get_option( &#039;show_on_front&#039; );
	}

	/**
	 * Is the front page a page we define?
	 *
	 * @param int $page_id Page ID.
	 * @return bool
	 */
	private function page_on_front_is( $page_id ) {
		return absint( get_option( &#039;page_on_front&#039; ) ) === absint( $page_id );
	}

	/**
	 * Returns a copy of `$query` with all query vars that are allowed on the front page stripped.
	 * Used when the shop page is also the front page.
	 *
	 * @param array $query The unfiltered array.
	 * @return array The filtered query vars.
	 */
	private function filter_out_valid_front_page_query_vars( $query ) {
		return array_filter(
			$query,
			function( $key ) {
				return ! $this-&gt;is_query_var_valid_on_front_page( $key );
			},
			ARRAY_FILTER_USE_KEY
		);
	}

	/**
	 * Checks whether a query var is allowed on the front page or not.
	 *
	 * @param string $query_var Query var name.
	 * @return boolean TRUE when query var is allowed on the front page. FALSE otherwise.
	 */
	private function is_query_var_valid_on_front_page( $query_var ) {
		return in_array( $query_var, array( &#039;preview&#039;, &#039;page&#039;, &#039;paged&#039;, &#039;cpage&#039;, &#039;orderby&#039; ), true )
			|| in_array( $query_var, array( &#039;min_price&#039;, &#039;max_price&#039;, &#039;rating_filter&#039; ), true )
			|| 0 === strpos( $query_var, &#039;filter_&#039; )
			|| 0 === strpos( $query_var, &#039;query_type_&#039; );
	}

	/**
	 * Hook into pre_get_posts to do the main product query.
	 *
	 * @param WP_Query $q Query instance.
	 */
	public function pre_get_posts( $q ) {
		// We only want to affect the main query.
		if ( ! $q-&gt;is_main_query() ) {
			return;
		}

		// Fixes for queries on static homepages.
		if ( $this-&gt;is_showing_page_on_front( $q ) ) {

			// Fix for endpoints on the homepage.
			if ( ! $this-&gt;page_on_front_is( $q-&gt;get( &#039;page_id&#039; ) ) ) {
				$_query = wp_parse_args( $q-&gt;query );
				if ( ! empty( $_query ) &amp;&amp; array_intersect( array_keys( $_query ), array_keys( $this-&gt;get_query_vars() ) ) ) {
					$q-&gt;is_page     = true;
					$q-&gt;is_home     = false;
					$q-&gt;is_singular = true;
					$q-&gt;set( &#039;page_id&#039;, (int) get_option( &#039;page_on_front&#039; ) );
					add_filter( &#039;redirect_canonical&#039;, &#039;__return_false&#039; );
				}
			}

			// When orderby is set, WordPress shows posts on the front-page. Get around that here.
			if ( $this-&gt;page_on_front_is( wc_get_page_id( &#039;shop&#039; ) ) ) {
				$_query = $this-&gt;filter_out_valid_front_page_query_vars( wp_parse_args( $q-&gt;query ) );

				if ( empty( $_query ) ) {
					$q-&gt;set( &#039;page_id&#039;, (int) get_option( &#039;page_on_front&#039; ) );
					$q-&gt;is_page = true;
					$q-&gt;is_home = false;

					// WP supporting themes show post type archive.
					if ( current_theme_supports( &#039;woocommerce&#039; ) ) {
						$q-&gt;set( &#039;post_type&#039;, &#039;product&#039; );
					} else {
						$q-&gt;is_singular = true;
					}
				}
			} elseif ( ! empty( $_GET[&#039;orderby&#039;] ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended
				$q-&gt;set( &#039;page_id&#039;, (int) get_option( &#039;page_on_front&#039; ) );
				$q-&gt;is_page     = true;
				$q-&gt;is_home     = false;
				$q-&gt;is_singular = true;
			}
		}

		// Fix product feeds.
		if ( $q-&gt;is_feed() &amp;&amp; $q-&gt;is_post_type_archive( &#039;product&#039; ) ) {
			$q-&gt;is_comment_feed = false;
		}

		// Special check for shops with the PRODUCT POST TYPE ARCHIVE on front.
		if ( current_theme_supports( &#039;woocommerce&#039; ) &amp;&amp; $q-&gt;is_page() &amp;&amp; &#039;page&#039; === get_option( &#039;show_on_front&#039; ) &amp;&amp; absint( $q-&gt;get( &#039;page_id&#039; ) ) === wc_get_page_id( &#039;shop&#039; ) ) {
			// This is a front-page shop.
			$q-&gt;set( &#039;post_type&#039;, &#039;product&#039; );
			$q-&gt;set( &#039;page_id&#039;, &#039;&#039; );

			if ( isset( $q-&gt;query[&#039;paged&#039;] ) ) {
				$q-&gt;set( &#039;paged&#039;, $q-&gt;query[&#039;paged&#039;] );
			}

			// Define a variable so we know this is the front page shop later on.
			wc_maybe_define_constant( &#039;SHOP_IS_ON_FRONT&#039;, true );

			// Get the actual WP page to avoid errors and let us use is_front_page().
			// This is hacky but works. Awaiting https://core.trac.wordpress.org/ticket/21096.
			global $wp_post_types;

			$shop_page = get_post( wc_get_page_id( &#039;shop&#039; ) );

			$wp_post_types[&#039;product&#039;]-&gt;ID         = $shop_page-&gt;ID;
			$wp_post_types[&#039;product&#039;]-&gt;post_title = $shop_page-&gt;post_title;
			$wp_post_types[&#039;product&#039;]-&gt;post_name  = $shop_page-&gt;post_name;
			$wp_post_types[&#039;product&#039;]-&gt;post_type  = $shop_page-&gt;post_type;
			$wp_post_types[&#039;product&#039;]-&gt;ancestors  = get_ancestors( $shop_page-&gt;ID, $shop_page-&gt;post_type );

			// Fix conditional Functions like is_front_page.
			$q-&gt;is_singular          = false;
			$q-&gt;is_post_type_archive = true;
			$q-&gt;is_archive           = true;
			$q-&gt;is_page              = true;

			// Remove post type archive name from front page title tag.
			add_filter( &#039;post_type_archive_title&#039;, &#039;__return_empty_string&#039;, 5 );

			// Fix WP SEO.
			if ( class_exists( &#039;WPSEO_Meta&#039; ) ) {
				add_filter( &#039;wpseo_metadesc&#039;, array( $this, &#039;wpseo_metadesc&#039; ) );
				add_filter( &#039;wpseo_metakey&#039;, array( $this, &#039;wpseo_metakey&#039; ) );
			}
		} elseif ( ! $q-&gt;is_post_type_archive( &#039;product&#039; ) &amp;&amp; ! $q-&gt;is_tax( get_object_taxonomies( &#039;product&#039; ) ) ) {
			// Only apply to product categories, the product post archive, the shop page, product tags, and product attribute taxonomies.
			return;
		}

		$this-&gt;product_query( $q );
	}

	/**
	 * Handler for the &#039;the_posts&#039; WP filter.
	 *
	 * @param array    $posts Posts from WP Query.
	 * @param WP_Query $query Current query.
	 *
	 * @return array
	 */
	public function handle_get_posts( $posts, $query ) {
		if ( &#039;product_query&#039; !== $query-&gt;get( &#039;wc_query&#039; ) ) {
			return $posts;
		}
		$this-&gt;remove_product_query_filters( $posts );
		return $posts;
	}


	/**
	 * Pre_get_posts above may adjust the main query to add WooCommerce logic. When this query is done, we need to ensure
	 * all custom filters are removed.
	 *
	 * This is done here during the_posts filter. The input is not changed.
	 *
	 * @param array $posts Posts from WP Query.
	 * @return array
	 */
	public function remove_product_query_filters( $posts ) {
		$this-&gt;remove_ordering_args();
		remove_filter( &#039;posts_clauses&#039;, array( $this, &#039;price_filter_post_clauses&#039; ), 10, 2 );
		return $posts;
	}

	/**
	 * This function used to be hooked to found_posts and adjust the posts count when the filtering by attribute
	 * widget was used and variable products were present. Now it isn&#039;t hooked anymore and does nothing but return
	 * the input unchanged, since the pull request in which it was introduced has been reverted.
	 *
	 * @since 4.4.0
	 * @param int      $count Original posts count, as supplied by the found_posts filter.
	 * @param WP_Query $query The current WP_Query object.
	 *
	 * @return int Adjusted posts count.
	 */
	public function adjust_posts_count( $count, $query ) {
		return $count;
	}

	/**
	 * Instance version of get_layered_nav_chosen_attributes, needed for unit tests.
	 *
	 * @return array
	 */
	protected function get_layered_nav_chosen_attributes_inst() {
		return self::get_layered_nav_chosen_attributes();
	}

	/**
	 * Get the posts (or the ids of the posts) found in the current WP loop.
	 *
	 * @return array Array of posts or post ids.
	 */
	protected function get_current_posts() {
		return $GLOBALS[&#039;wp_query&#039;]-&gt;posts;
	}

	/**
	 * WP SEO meta description.
	 *
	 * Hooked into wpseo_ hook already, so no need for function_exist.
	 *
	 * @return string
	 */
	public function wpseo_metadesc() {
		return WPSEO_Meta::get_value( &#039;metadesc&#039;, wc_get_page_id( &#039;shop&#039; ) );
	}

	/**
	 * WP SEO meta key.
	 *
	 * Hooked into wpseo_ hook already, so no need for function_exist.
	 *
	 * @return string
	 */
	public function wpseo_metakey() {
		return WPSEO_Meta::get_value( &#039;metakey&#039;, wc_get_page_id( &#039;shop&#039; ) );
	}

	/**
	 * Query the products, applying sorting/ordering etc.
	 * This applies to the main WordPress loop.
	 *
	 * @param WP_Query $q Query instance.
	 */
	public function product_query( $q ) {
		if ( ! is_feed() ) {
			$ordering = $this-&gt;get_catalog_ordering_args();
			$q-&gt;set( &#039;orderby&#039;, $ordering[&#039;orderby&#039;] );
			$q-&gt;set( &#039;order&#039;, $ordering[&#039;order&#039;] );

			if ( isset( $ordering[&#039;meta_key&#039;] ) ) {
				$q-&gt;set( &#039;meta_key&#039;, $ordering[&#039;meta_key&#039;] );
			}
		}

		// Query vars that affect posts shown.
		$q-&gt;set( &#039;meta_query&#039;, $this-&gt;get_meta_query( $q-&gt;get( &#039;meta_query&#039; ), true ) );
		$q-&gt;set( &#039;tax_query&#039;, $this-&gt;get_tax_query( $q-&gt;get( &#039;tax_query&#039; ), true ) );
		$q-&gt;set( &#039;wc_query&#039;, &#039;product_query&#039; );
		$q-&gt;set( &#039;post__in&#039;, array_unique( (array) apply_filters( &#039;loop_shop_post_in&#039;, array() ) ) );

		// Work out how many products to query.
		$q-&gt;set( &#039;posts_per_page&#039;, $q-&gt;get( &#039;posts_per_page&#039; ) ? $q-&gt;get( &#039;posts_per_page&#039; ) : apply_filters( &#039;loop_shop_per_page&#039;, wc_get_default_products_per_row() * wc_get_default_product_rows_per_page() ) );

		// Store reference to this query.
		self::$product_query = $q;

		// Additional hooks to change WP Query.
		self::add_filter( &#039;posts_clauses&#039;, array( $this, &#039;product_query_post_clauses&#039; ), 10, 2 );
		add_filter( &#039;the_posts&#039;, array( $this, &#039;handle_get_posts&#039; ), 10, 2 );

		do_action( &#039;woocommerce_product_query&#039;, $q, $this );
	}

	/**
	 * Add extra clauses to the product query.
	 *
	 * @param array    $args Product query clauses.
	 * @param WP_Query $wp_query The current product query.
	 * @return array The updated product query clauses array.
	 */
	private function product_query_post_clauses( $args, $wp_query ) {
		$args = $this-&gt;price_filter_post_clauses( $args, $wp_query );
		$args = $this-&gt;filterer-&gt;filter_by_attribute_post_clauses( $args, $wp_query, $this-&gt;get_layered_nav_chosen_attributes() );

		return $args;
	}

	/**
	 * Remove the query.
	 */
	public function remove_product_query() {
		remove_action( &#039;pre_get_posts&#039;, array( $this, &#039;pre_get_posts&#039; ) );
	}

	/**
	 * Remove ordering queries.
	 */
	public function remove_ordering_args() {
		remove_filter( &#039;posts_clauses&#039;, array( $this, &#039;order_by_price_asc_post_clauses&#039; ) );
		remove_filter( &#039;posts_clauses&#039;, array( $this, &#039;order_by_price_desc_post_clauses&#039; ) );
		remove_filter( &#039;posts_clauses&#039;, array( $this, &#039;order_by_popularity_post_clauses&#039; ) );
		remove_filter( &#039;posts_clauses&#039;, array( $this, &#039;order_by_rating_post_clauses&#039; ) );
	}

	/**
	 * Returns an array of arguments for ordering products based on the selected values.
	 *
	 * @param string $orderby Order by param.
	 * @param string $order Order param.
	 * @return array
	 */
	public function get_catalog_ordering_args( $orderby = &#039;&#039;, $order = &#039;&#039; ) {
		// Get ordering from query string unless defined.
		if ( ! $orderby ) {
			// phpcs:ignore WordPress.Security.NonceVerification.Recommended
			$orderby_value = isset( $_GET[&#039;orderby&#039;] ) ? wc_clean( (string) wp_unslash( $_GET[&#039;orderby&#039;] ) ) : wc_clean( get_query_var( &#039;orderby&#039; ) );

			if ( ! $orderby_value ) {
				if ( is_search() ) {
					$orderby_value = &#039;relevance&#039;;
				} else {
					$orderby_value = apply_filters( &#039;woocommerce_default_catalog_orderby&#039;, get_option( &#039;woocommerce_default_catalog_orderby&#039;, &#039;menu_order&#039; ) );
				}
			}

			// Get order + orderby args from string.
			$orderby_value = is_array( $orderby_value ) ? $orderby_value : explode( &#039;-&#039;, $orderby_value );
			$orderby       = esc_attr( $orderby_value[0] );
			$order         = ! empty( $orderby_value[1] ) ? $orderby_value[1] : $order;
		}

		// Convert to correct format.
		$orderby = strtolower( is_array( $orderby ) ? (string) current( $orderby ) : (string) $orderby );
		$order   = strtoupper( is_array( $order ) ? (string) current( $order ) : (string) $order );
		$args    = array(
			&#039;orderby&#039;  =&gt; $orderby,
			&#039;order&#039;    =&gt; ( &#039;DESC&#039; === $order ) ? &#039;DESC&#039; : &#039;ASC&#039;,
			&#039;meta_key&#039; =&gt; &#039;&#039;, // @codingStandardsIgnoreLine
		);

		switch ( $orderby ) {
			case &#039;id&#039;:
				$args[&#039;orderby&#039;] = &#039;ID&#039;;
				break;
			case &#039;menu_order&#039;:
				$args[&#039;orderby&#039;] = &#039;menu_order title&#039;;
				break;
			case &#039;title&#039;:
				$args[&#039;orderby&#039;] = &#039;title&#039;;
				$args[&#039;order&#039;]   = ( &#039;DESC&#039; === $order ) ? &#039;DESC&#039; : &#039;ASC&#039;;
				break;
			case &#039;relevance&#039;:
				$args[&#039;orderby&#039;] = &#039;relevance&#039;;
				$args[&#039;order&#039;]   = &#039;DESC&#039;;
				break;
			case &#039;rand&#039;:
				$args[&#039;orderby&#039;] = &#039;rand&#039;; // @codingStandardsIgnoreLine
				break;
			case &#039;date&#039;:
				$args[&#039;orderby&#039;] = &#039;date ID&#039;;
				$args[&#039;order&#039;]   = ( &#039;ASC&#039; === $order ) ? &#039;ASC&#039; : &#039;DESC&#039;;
				break;
			case &#039;price&#039;:
				$callback = &#039;DESC&#039; === $order ? &#039;order_by_price_desc_post_clauses&#039; : &#039;order_by_price_asc_post_clauses&#039;;
				add_filter( &#039;posts_clauses&#039;, array( $this, $callback ) );
				break;
			case &#039;popularity&#039;:
				add_filter( &#039;posts_clauses&#039;, array( $this, &#039;order_by_popularity_post_clauses&#039; ) );
				break;
			case &#039;rating&#039;:
				add_filter( &#039;posts_clauses&#039;, array( $this, &#039;order_by_rating_post_clauses&#039; ) );
				break;
		}

		return apply_filters( &#039;woocommerce_get_catalog_ordering_args&#039;, $args, $orderby, $order );
	}

	/**
	 * Custom query used to filter products by price.
	 *
	 * @since 3.6.0
	 *
	 * @param array    $args Query args.
	 * @param WP_Query $wp_query WP_Query object.
	 *
	 * @return array
	 */
	public function price_filter_post_clauses( $args, $wp_query ) {
		global $wpdb;

		// phpcs:ignore WordPress.Security.NonceVerification.Recommended
		if ( ! $wp_query-&gt;is_main_query() || ( ! isset( $_GET[&#039;max_price&#039;] ) &amp;&amp; ! isset( $_GET[&#039;min_price&#039;] ) ) ) {
			return $args;
		}

		// phpcs:disable WordPress.Security.NonceVerification.Recommended
		$current_min_price = isset( $_GET[&#039;min_price&#039;] ) ? floatval( wp_unslash( $_GET[&#039;min_price&#039;] ) ) : 0;
		$current_max_price = isset( $_GET[&#039;max_price&#039;] ) ? floatval( wp_unslash( $_GET[&#039;max_price&#039;] ) ) : PHP_INT_MAX;
		// phpcs:enable WordPress.Security.NonceVerification.Recommended

		/**
		 * Adjust if the store taxes are not displayed how they are stored.
		 * Kicks in when prices excluding tax are displayed including tax.
		 */
		if ( wc_tax_enabled() &amp;&amp; &#039;incl&#039; === get_option( &#039;woocommerce_tax_display_shop&#039; ) &amp;&amp; ! wc_prices_include_tax() ) {
			$tax_class = apply_filters( &#039;woocommerce_price_filter_widget_tax_class&#039;, &#039;&#039; ); // Uses standard tax class.
			$tax_rates = WC_Tax::get_rates( $tax_class );

			if ( $tax_rates ) {
				$current_min_price -= WC_Tax::get_tax_total( WC_Tax::calc_inclusive_tax( $current_min_price, $tax_rates ) );
				$current_max_price -= WC_Tax::get_tax_total( WC_Tax::calc_inclusive_tax( $current_max_price, $tax_rates ) );
			}
		}

		$args[&#039;join&#039;]   = $this-&gt;append_product_sorting_table_join( $args[&#039;join&#039;] );
		$args[&#039;where&#039;] .= $wpdb-&gt;prepare(
			&#039; AND NOT (%f&lt;wc_product_meta_lookup.min_price OR %f&gt;wc_product_meta_lookup.max_price ) &#039;,
			$current_max_price,
			$current_min_price
		);
		return $args;
	}

	/**
	 * Handle numeric price sorting.
	 *
	 * @param array $args Query args.
	 * @return array
	 */
	public function order_by_price_asc_post_clauses( $args ) {
		$args[&#039;join&#039;]    = $this-&gt;append_product_sorting_table_join( $args[&#039;join&#039;] );
		$args[&#039;orderby&#039;] = &#039; wc_product_meta_lookup.min_price ASC, wc_product_meta_lookup.product_id ASC &#039;;
		return $args;
	}

	/**
	 * Handle numeric price sorting.
	 *
	 * @param array $args Query args.
	 * @return array
	 */
	public function order_by_price_desc_post_clauses( $args ) {
		$args[&#039;join&#039;]    = $this-&gt;append_product_sorting_table_join( $args[&#039;join&#039;] );
		$args[&#039;orderby&#039;] = &#039; wc_product_meta_lookup.max_price DESC, wc_product_meta_lookup.product_id DESC &#039;;
		return $args;
	}

	/**
	 * WP Core does not let us change the sort direction for individual orderby params - https://core.trac.wordpress.org/ticket/17065.
	 *
	 * This lets us sort by meta value desc, and have a second orderby param.
	 *
	 * @param array $args Query args.
	 * @return array
	 */
	public function order_by_popularity_post_clauses( $args ) {
		$args[&#039;join&#039;]    = $this-&gt;append_product_sorting_table_join( $args[&#039;join&#039;] );
		$args[&#039;orderby&#039;] = &#039; wc_product_meta_lookup.total_sales DESC, wc_product_meta_lookup.product_id DESC &#039;;
		return $args;
	}

	/**
	 * Order by rating post clauses.
	 *
	 * @param array $args Query args.
	 * @return array
	 */
	public function order_by_rating_post_clauses( $args ) {
		$args[&#039;join&#039;]    = $this-&gt;append_product_sorting_table_join( $args[&#039;join&#039;] );
		$args[&#039;orderby&#039;] = &#039; wc_product_meta_lookup.average_rating DESC, wc_product_meta_lookup.rating_count DESC, wc_product_meta_lookup.product_id DESC &#039;;
		return $args;
	}

	/**
	 * Join wc_product_meta_lookup to posts if not already joined.
	 *
	 * @param string $sql SQL join.
	 * @return string
	 */
	private function append_product_sorting_table_join( $sql ) {
		global $wpdb;

		if ( ! strstr( $sql, &#039;wc_product_meta_lookup&#039; ) ) {
			$sql .= &quot; LEFT JOIN {$wpdb-&gt;wc_product_meta_lookup} wc_product_meta_lookup ON $wpdb-&gt;posts.ID = wc_product_meta_lookup.product_id &quot;;
		}
		return $sql;
	}

	/**
	 * Appends meta queries to an array.
	 *
	 * @param  array $meta_query Meta query.
	 * @param  bool  $main_query If is main query.
	 * @return array
	 */
	public function get_meta_query( $meta_query = array(), $main_query = false ) {
		if ( ! is_array( $meta_query ) ) {
			$meta_query = array();
		}
		return array_filter( apply_filters( &#039;woocommerce_product_query_meta_query&#039;, $meta_query, $this ) );
	}

	/**
	 * Appends tax queries to an array.
	 *
	 * @param  array $tax_query  Tax query.
	 * @param  bool  $main_query If is main query.
	 * @return array
	 */
	public function get_tax_query( $tax_query = array(), $main_query = false ) {
		if ( ! is_array( $tax_query ) ) {
			$tax_query = array(
				&#039;relation&#039; =&gt; &#039;AND&#039;,
			);
		}

		if ( $main_query &amp;&amp; ! $this-&gt;filterer-&gt;filtering_via_lookup_table_is_active() ) {
			// Layered nav filters on terms.
			foreach ( $this-&gt;get_layered_nav_chosen_attributes() as $taxonomy =&gt; $data ) {
				$tax_query[] = array(
					&#039;taxonomy&#039;         =&gt; $taxonomy,
					&#039;field&#039;            =&gt; &#039;slug&#039;,
					&#039;terms&#039;            =&gt; $data[&#039;terms&#039;],
					&#039;operator&#039;         =&gt; &#039;and&#039; === $data[&#039;query_type&#039;] ? &#039;AND&#039; : &#039;IN&#039;,
					&#039;include_children&#039; =&gt; false,
				);
			}
		}

		$product_visibility_terms  = wc_get_product_visibility_term_ids();
		$product_visibility_not_in = array( is_search() &amp;&amp; $main_query ? $product_visibility_terms[&#039;exclude-from-search&#039;] : $product_visibility_terms[&#039;exclude-from-catalog&#039;] );

		// Hide out of stock products.
		if ( &#039;yes&#039; === get_option( &#039;woocommerce_hide_out_of_stock_items&#039; ) ) {
			$product_visibility_not_in[] = $product_visibility_terms[&#039;outofstock&#039;];
		}

		// phpcs:disable WordPress.Security.NonceVerification.Recommended
		// Filter by rating.
		if ( isset( $_GET[&#039;rating_filter&#039;] ) ) {
			// phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			$rating_filter = array_filter( array_map( &#039;absint&#039;, explode( &#039;,&#039;, wp_unslash( $_GET[&#039;rating_filter&#039;] ) ) ) );
			$rating_terms  = array();
			for ( $i = 1; $i &lt;= 5; $i ++ ) {
				if ( in_array( $i, $rating_filter, true ) &amp;&amp; isset( $product_visibility_terms[ &#039;rated-&#039; . $i ] ) ) {
					$rating_terms[] = $product_visibility_terms[ &#039;rated-&#039; . $i ];
				}
			}
			if ( ! empty( $rating_terms ) ) {
				$tax_query[] = array(
					&#039;taxonomy&#039;      =&gt; &#039;product_visibility&#039;,
					&#039;field&#039;         =&gt; &#039;term_taxonomy_id&#039;,
					&#039;terms&#039;         =&gt; $rating_terms,
					&#039;operator&#039;      =&gt; &#039;IN&#039;,
					&#039;rating_filter&#039; =&gt; true,
				);
			}
		}
		// phpcs:enable WordPress.Security.NonceVerification.Recommended

		if ( ! empty( $product_visibility_not_in ) ) {
			$tax_query[] = array(
				&#039;taxonomy&#039; =&gt; &#039;product_visibility&#039;,
				&#039;field&#039;    =&gt; &#039;term_taxonomy_id&#039;,
				&#039;terms&#039;    =&gt; $product_visibility_not_in,
				&#039;operator&#039; =&gt; &#039;NOT IN&#039;,
			);
		}

		return array_filter( apply_filters( &#039;woocommerce_product_query_tax_query&#039;, $tax_query, $this ) );
	}

	/**
	 * Get the main query which product queries ran against.
	 *
	 * @return WP_Query
	 */
	public static function get_main_query() {
		return self::$product_query;
	}

	/**
	 * Get the tax query which was used by the main query.
	 *
	 * @return array
	 */
	public static function get_main_tax_query() {
		$tax_query = isset( self::$product_query-&gt;tax_query, self::$product_query-&gt;tax_query-&gt;queries ) ? self::$product_query-&gt;tax_query-&gt;queries : array();

		return $tax_query;
	}

	/**
	 * Get the meta query which was used by the main query.
	 *
	 * @return array
	 */
	public static function get_main_meta_query() {
		$args       = self::$product_query-&gt;query_vars;
		$meta_query = isset( $args[&#039;meta_query&#039;] ) ? $args[&#039;meta_query&#039;] : array();

		return $meta_query;
	}

	/**
	 * Based on WP_Query::parse_search
	 */
	public static function get_main_search_query_sql() {
		global $wpdb;

		$args         = self::$product_query-&gt;query_vars;
		$search_terms = isset( $args[&#039;search_terms&#039;] ) ? $args[&#039;search_terms&#039;] : array();
		$sql          = array();

		foreach ( $search_terms as $term ) {
			// Terms prefixed with &#039;-&#039; should be excluded.
			$include = &#039;-&#039; !== substr( $term, 0, 1 );

			if ( $include ) {
				$like_op  = &#039;LIKE&#039;;
				$andor_op = &#039;OR&#039;;
			} else {
				$like_op  = &#039;NOT LIKE&#039;;
				$andor_op = &#039;AND&#039;;
				$term     = substr( $term, 1 );
			}

			$like = &#039;%&#039; . $wpdb-&gt;esc_like( $term ) . &#039;%&#039;;
			// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
			$sql[] = $wpdb-&gt;prepare( &quot;(($wpdb-&gt;posts.post_title $like_op %s) $andor_op ($wpdb-&gt;posts.post_excerpt $like_op %s) $andor_op ($wpdb-&gt;posts.post_content $like_op %s))&quot;, $like, $like, $like );
		}

		if ( ! empty( $sql ) &amp;&amp; ! is_user_logged_in() ) {
			$sql[] = &quot;($wpdb-&gt;posts.post_password = &#039;&#039;)&quot;;
		}

		return implode( &#039; AND &#039;, $sql );
	}

	/**
	 * Get an array of attributes and terms selected with the layered nav widget.
	 *
	 * @return array
	 */
	public static function get_layered_nav_chosen_attributes() {
		// phpcs:disable WordPress.Security.NonceVerification.Recommended
		if ( ! is_array( self::$chosen_attributes ) ) {
			self::$chosen_attributes = array();

			if ( ! empty( $_GET ) ) {
				foreach ( $_GET as $key =&gt; $value ) {
					if ( 0 === strpos( $key, &#039;filter_&#039; ) ) {
						$attribute    = wc_sanitize_taxonomy_name( str_replace( &#039;filter_&#039;, &#039;&#039;, $key ) );
						$taxonomy     = wc_attribute_taxonomy_name( $attribute );
						$filter_terms = ! empty( $value ) ? explode( &#039;,&#039;, wc_clean( wp_unslash( $value ) ) ) : array();

						if ( empty( $filter_terms ) || ! taxonomy_exists( $taxonomy ) || ! wc_attribute_taxonomy_id_by_name( $attribute ) ) {
							continue;
						}

						$query_type                                    = ! empty( $_GET[ &#039;query_type_&#039; . $attribute ] ) &amp;&amp; in_array( $_GET[ &#039;query_type_&#039; . $attribute ], array( &#039;and&#039;, &#039;or&#039; ), true ) ? wc_clean( wp_unslash( $_GET[ &#039;query_type_&#039; . $attribute ] ) ) : &#039;&#039;;
						self::$chosen_attributes[ $taxonomy ][&#039;terms&#039;] = array_map( &#039;sanitize_title&#039;, $filter_terms ); // Ensures correct encoding.
						self::$chosen_attributes[ $taxonomy ][&#039;query_type&#039;] = $query_type ? $query_type : apply_filters( &#039;woocommerce_layered_nav_default_query_type&#039;, &#039;and&#039; );
					}
				}
			}
		}
		return self::$chosen_attributes;
		// phpcs:disable WordPress.Security.NonceVerification.Recommended
	}

	/**
	 * Remove the add-to-cart param from pagination urls.
	 *
	 * @param string $url URL.
	 * @return string
	 */
	public function remove_add_to_cart_pagination( $url ) {
		return remove_query_arg( &#039;add-to-cart&#039;, $url );
	}

	/**
	 * Return a meta query for filtering by rating.
	 *
	 * @deprecated 3.0.0 Replaced with taxonomy.
	 * @return array
	 */
	public function rating_filter_meta_query() {
		return array();
	}

	/**
	 * Returns a meta query to handle product visibility.
	 *
	 * @deprecated 3.0.0 Replaced with taxonomy.
	 * @param string $compare (default: &#039;IN&#039;).
	 * @return array
	 */
	public function visibility_meta_query( $compare = &#039;IN&#039; ) {
		return array();
	}

	/**
	 * Returns a meta query to handle product stock status.
	 *
	 * @deprecated 3.0.0 Replaced with taxonomy.
	 * @param string $status (default: &#039;instock&#039;).
	 * @return array
	 */
	public function stock_status_meta_query( $status = &#039;instock&#039; ) {
		return array();
	}

	/**
	 * Layered nav init.
	 *
	 * @deprecated 2.6.0
	 */
	public function layered_nav_init() {
		wc_deprecated_function( &#039;layered_nav_init&#039;, &#039;2.6&#039; );
	}

	/**
	 * Get an unpaginated list all product IDs (both filtered and unfiltered). Makes use of transients.
	 *
	 * @deprecated 2.6.0 due to performance concerns
	 */
	public function get_products_in_view() {
		wc_deprecated_function( &#039;get_products_in_view&#039;, &#039;2.6&#039; );
	}

	/**
	 * Layered Nav post filter.
	 *
	 * @deprecated 2.6.0 due to performance concerns
	 *
	 * @param mixed $deprecated Deprecated.
	 */
	public function layered_nav_query( $deprecated ) {
		wc_deprecated_function( &#039;layered_nav_query&#039;, &#039;2.6&#039; );
	}

	/**
	 * Search post excerpt.
	 *
	 * @param string $where Where clause.
	 *
	 * @deprecated 3.2.0 - Not needed anymore since WordPress 4.5.
	 */
	public function search_post_excerpt( $where = &#039;&#039; ) {
		wc_deprecated_function( &#039;WC_Query::search_post_excerpt&#039;, &#039;3.2.0&#039;, &#039;Excerpt added to search query by default since WordPress 4.5.&#039; );
		return $where;
	}

	/**
	 * Remove the posts_where filter.
	 *
	 * @deprecated 3.2.0 - Nothing to remove anymore because search_post_excerpt() is deprecated.
	 */
	public function remove_posts_where() {
		wc_deprecated_function( &#039;WC_Query::remove_posts_where&#039;, &#039;3.2.0&#039;, &#039;Nothing to remove anymore because search_post_excerpt() is deprecated.&#039; );
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on August 24th, 2023 at 08:49 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1692866947"></script>
    <script src="../js/search.js?updated=1692866947"></script>
</body>
</html>
