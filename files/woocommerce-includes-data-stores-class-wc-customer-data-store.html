<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1692866947">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1692866947">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/woocommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/woocommerce-admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="../namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="../namespaces/automattic-woocommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-Classes.html"><abbr title="\WooCommerce\Classes">Classes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Abstracts.html"><abbr title="\WooCommerce\Abstracts">Abstracts</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Admin.html"><abbr title="\WooCommerce\Admin">Admin</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Helper.html"><abbr title="\WooCommerce\Helper">Helper</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Views.html"><abbr title="\WooCommerce\Views">Views</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Templates.html"><abbr title="\WooCommerce\Templates">Templates</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Reports.html"><abbr title="\WooCommerce\Reports">Reports</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Blocks.html"><abbr title="\WooCommerce\Blocks">Blocks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-RestApi.html"><abbr title="\WooCommerce\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-CLI.html"><abbr title="\WooCommerce\CLI">CLI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-l10n.html"><abbr title="\WooCommerce\l10n">l10n</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Webhooks.html"><abbr title="\WooCommerce\Webhooks">Webhooks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-DataStores.html"><abbr title="\WooCommerce\DataStores">DataStores</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Emails.html"><abbr title="\WooCommerce\Emails">Emails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Export.html"><abbr title="\WooCommerce\Export">Export</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Gateways.html"><abbr title="\WooCommerce\Gateways">Gateways</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PayPal.html"><abbr title="\WooCommerce\PayPal">PayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Import.html"><abbr title="\WooCommerce\Import">Import</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Integrations.html"><abbr title="\WooCommerce\Integrations">Integrations</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interfaces.html"><abbr title="\WooCommerce\Interfaces">Interfaces</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Interface.html"><abbr title="\WooCommerce\Interface">Interface</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-LogHandlers.html"><abbr title="\WooCommerce\LogHandlers">LogHandlers</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-PaymentTokens.html"><abbr title="\WooCommerce\PaymentTokens">PaymentTokens</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Utilities.html"><abbr title="\WooCommerce\Utilities">Utilities</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shipping.html"><abbr title="\WooCommerce\Shipping">Shipping</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Shortcodes.html"><abbr title="\WooCommerce\Shortcodes">Shortcodes</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Tracks.html"><abbr title="\WooCommerce\Tracks">Tracks</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Traits.html"><abbr title="\WooCommerce\Traits">Traits</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Functions.html"><abbr title="\WooCommerce\Functions">Functions</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCom.html"><abbr title="\WooCommerce\WCCom">WCCom</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-WCCOM.html"><abbr title="\WooCommerce\WCCOM">WCCOM</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Widgets.html"><abbr title="\WooCommerce\Widgets">Widgets</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-Uninstaller.html"><abbr title="\WooCommerce\Uninstaller">Uninstaller</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceAdmin.html"><abbr title="\WoocommerceAdmin">WoocommerceAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WoocommerceNavigation.html"><abbr title="\WoocommerceNavigation">WoocommerceNavigation</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/Automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/Automattic-WooCommerce.html"><abbr title="\Automattic\WooCommerce">WooCommerce</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wc-customer-data-store.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Class WC_Customer_Data_Store file.
 *
 * @package WooCommerce\DataStores
 */

use Automattic\WooCommerce\Internal\DataStores\Orders\CustomOrdersTableController;
use Automattic\WooCommerce\Internal\DataStores\Orders\OrdersTableDataStore;

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit;
}

/**
 * WC Customer Data Store.
 *
 * @version  3.0.0
 */
class WC_Customer_Data_Store extends WC_Data_Store_WP implements WC_Customer_Data_Store_Interface, WC_Object_Data_Store_Interface {

	/**
	 * Data stored in meta keys, but not considered &quot;meta&quot;.
	 *
	 * @since 3.0.0
	 * @var array
	 */
	protected $internal_meta_keys = array(
		&#039;locale&#039;,
		&#039;billing_postcode&#039;,
		&#039;billing_city&#039;,
		&#039;billing_address_1&#039;,
		&#039;billing_address_2&#039;,
		&#039;billing_state&#039;,
		&#039;billing_country&#039;,
		&#039;shipping_postcode&#039;,
		&#039;shipping_city&#039;,
		&#039;shipping_address_1&#039;,
		&#039;shipping_address_2&#039;,
		&#039;shipping_state&#039;,
		&#039;shipping_country&#039;,
		&#039;paying_customer&#039;,
		&#039;last_update&#039;,
		&#039;first_name&#039;,
		&#039;last_name&#039;,
		&#039;display_name&#039;,
		&#039;show_admin_bar_front&#039;,
		&#039;use_ssl&#039;,
		&#039;admin_color&#039;,
		&#039;rich_editing&#039;,
		&#039;comment_shortcuts&#039;,
		&#039;dismissed_wp_pointers&#039;,
		&#039;show_welcome_panel&#039;,
		&#039;session_tokens&#039;,
		&#039;nickname&#039;,
		&#039;description&#039;,
		&#039;billing_first_name&#039;,
		&#039;billing_last_name&#039;,
		&#039;billing_company&#039;,
		&#039;billing_phone&#039;,
		&#039;billing_email&#039;,
		&#039;shipping_first_name&#039;,
		&#039;shipping_last_name&#039;,
		&#039;shipping_company&#039;,
		&#039;shipping_phone&#039;,
		&#039;wptests_capabilities&#039;,
		&#039;wptests_user_level&#039;,
		&#039;syntax_highlighting&#039;,
		&#039;_order_count&#039;,
		&#039;_money_spent&#039;,
		&#039;_last_order&#039;,
		&#039;_woocommerce_tracks_anon_id&#039;,
	);

	/**
	 * Internal meta type used to store user data.
	 *
	 * @var string
	 */
	protected $meta_type = &#039;user&#039;;

	/**
	 * Callback to remove unwanted meta data.
	 *
	 * @param object $meta Meta object.
	 * @return bool
	 */
	protected function exclude_internal_meta_keys( $meta ) {
		global $wpdb;

		$table_prefix = $wpdb-&gt;prefix ? $wpdb-&gt;prefix : &#039;wp_&#039;;

		return ! in_array( $meta-&gt;meta_key, $this-&gt;internal_meta_keys, true )
			&amp;&amp; 0 !== strpos( $meta-&gt;meta_key, &#039;_woocommerce_persistent_cart&#039; )
			&amp;&amp; 0 !== strpos( $meta-&gt;meta_key, &#039;closedpostboxes_&#039; )
			&amp;&amp; 0 !== strpos( $meta-&gt;meta_key, &#039;metaboxhidden_&#039; )
			&amp;&amp; 0 !== strpos( $meta-&gt;meta_key, &#039;manageedit-&#039; )
			&amp;&amp; ! strstr( $meta-&gt;meta_key, $table_prefix )
			&amp;&amp; 0 !== stripos( $meta-&gt;meta_key, &#039;wp_&#039; );
	}

	/**
	 * Method to create a new customer in the database.
	 *
	 * @since 3.0.0
	 *
	 * @param WC_Customer $customer Customer object.
	 *
	 * @throws WC_Data_Exception If unable to create new customer.
	 */
	public function create( &amp;$customer ) {
		$id = wc_create_new_customer( $customer-&gt;get_email(), $customer-&gt;get_username(), $customer-&gt;get_password() );

		if ( is_wp_error( $id ) ) {
			throw new WC_Data_Exception( $id-&gt;get_error_code(), $id-&gt;get_error_message() );
		}

		$customer-&gt;set_id( $id );
		$this-&gt;update_user_meta( $customer );

		// Prevent wp_update_user calls in the same request and customer trigger the &#039;Notice of Password Changed&#039; email.
		$customer-&gt;set_password( &#039;&#039; );

		wp_update_user(
			apply_filters(
				&#039;woocommerce_update_customer_args&#039;,
				array(
					&#039;ID&#039;           =&gt; $customer-&gt;get_id(),
					&#039;role&#039;         =&gt; $customer-&gt;get_role(),
					&#039;display_name&#039; =&gt; $customer-&gt;get_display_name(),
				),
				$customer
			)
		);
		$wp_user = new WP_User( $customer-&gt;get_id() );
		$customer-&gt;set_date_created( $wp_user-&gt;user_registered );
		$customer-&gt;set_date_modified( get_user_meta( $customer-&gt;get_id(), &#039;last_update&#039;, true ) );
		$customer-&gt;save_meta_data();
		$customer-&gt;apply_changes();
		do_action( &#039;woocommerce_new_customer&#039;, $customer-&gt;get_id(), $customer );
	}

	/**
	 * Method to read a customer object.
	 *
	 * @since 3.0.0
	 * @param WC_Customer $customer Customer object.
	 * @throws Exception If invalid customer.
	 */
	public function read( &amp;$customer ) {
		$user_object = $customer-&gt;get_id() ? get_user_by( &#039;id&#039;, $customer-&gt;get_id() ) : false;

		// User object is required.
		if ( ! $user_object || empty( $user_object-&gt;ID ) ) {
			throw new Exception( __( &#039;Invalid customer.&#039;, &#039;woocommerce&#039; ) );
		}

		$customer_id = $customer-&gt;get_id();

		// Load meta but exclude deprecated props and parent keys.
		$user_meta = array_diff_key(
			array_change_key_case( array_map( &#039;wc_flatten_meta_callback&#039;, get_user_meta( $customer_id ) ) ),
			array_flip( array( &#039;country&#039;, &#039;state&#039;, &#039;postcode&#039;, &#039;city&#039;, &#039;address&#039;, &#039;address_2&#039;, &#039;default&#039;, &#039;location&#039; ) ),
			array_change_key_case( (array) $user_object-&gt;data )
		);

		$customer-&gt;set_props( $user_meta );
		$customer-&gt;set_props(
			array(
				&#039;is_paying_customer&#039; =&gt; get_user_meta( $customer_id, &#039;paying_customer&#039;, true ),
				&#039;email&#039;              =&gt; $user_object-&gt;user_email,
				&#039;username&#039;           =&gt; $user_object-&gt;user_login,
				&#039;display_name&#039;       =&gt; $user_object-&gt;display_name,
				&#039;date_created&#039;       =&gt; $user_object-&gt;user_registered, // Mysql string in local format.
				&#039;date_modified&#039;      =&gt; get_user_meta( $customer_id, &#039;last_update&#039;, true ),
				&#039;role&#039;               =&gt; ! empty( $user_object-&gt;roles[0] ) ? $user_object-&gt;roles[0] : &#039;customer&#039;,
			)
		);
		$customer-&gt;read_meta_data();
		$customer-&gt;set_object_read( true );
		do_action( &#039;woocommerce_customer_loaded&#039;, $customer );
	}

	/**
	 * Updates a customer in the database.
	 *
	 * @since 3.0.0
	 * @param WC_Customer $customer Customer object.
	 */
	public function update( &amp;$customer ) {
		wp_update_user(
			apply_filters(
				&#039;woocommerce_update_customer_args&#039;,
				array(
					&#039;ID&#039;           =&gt; $customer-&gt;get_id(),
					&#039;user_email&#039;   =&gt; $customer-&gt;get_email(),
					&#039;display_name&#039; =&gt; $customer-&gt;get_display_name(),
				),
				$customer
			)
		);

		// Only update password if a new one was set with set_password.
		if ( $customer-&gt;get_password() ) {
			wp_update_user(
				array(
					&#039;ID&#039;        =&gt; $customer-&gt;get_id(),
					&#039;user_pass&#039; =&gt; $customer-&gt;get_password(),
				)
			);
			$customer-&gt;set_password( &#039;&#039; );
		}

		$this-&gt;update_user_meta( $customer );
		$customer-&gt;set_date_modified( get_user_meta( $customer-&gt;get_id(), &#039;last_update&#039;, true ) );
		$customer-&gt;save_meta_data();
		$customer-&gt;apply_changes();
		do_action( &#039;woocommerce_update_customer&#039;, $customer-&gt;get_id(), $customer );
	}

	/**
	 * Deletes a customer from the database.
	 *
	 * @since 3.0.0
	 * @param WC_Customer $customer Customer object.
	 * @param array       $args Array of args to pass to the delete method.
	 */
	public function delete( &amp;$customer, $args = array() ) {
		if ( ! $customer-&gt;get_id() ) {
			return;
		}

		$args = wp_parse_args(
			$args,
			array(
				&#039;reassign&#039; =&gt; 0,
			)
		);

		$id = $customer-&gt;get_id();
		wp_delete_user( $id, $args[&#039;reassign&#039;] );

		do_action( &#039;woocommerce_delete_customer&#039;, $id );
	}

	/**
	 * Helper method that updates all the meta for a customer. Used for update &amp; create.
	 *
	 * @since 3.0.0
	 * @param WC_Customer $customer Customer object.
	 */
	private function update_user_meta( $customer ) {
		$updated_props = array();
		$changed_props = $customer-&gt;get_changes();

		$meta_key_to_props = array(
			&#039;paying_customer&#039; =&gt; &#039;is_paying_customer&#039;,
			&#039;first_name&#039;      =&gt; &#039;first_name&#039;,
			&#039;last_name&#039;       =&gt; &#039;last_name&#039;,
		);

		foreach ( $meta_key_to_props as $meta_key =&gt; $prop ) {
			if ( ! array_key_exists( $prop, $changed_props ) ) {
				continue;
			}

			if ( update_user_meta( $customer-&gt;get_id(), $meta_key, $customer-&gt;{&quot;get_$prop&quot;}( &#039;edit&#039; ) ) ) {
				$updated_props[] = $prop;
			}
		}

		$billing_address_props = array(
			&#039;billing_first_name&#039; =&gt; &#039;billing_first_name&#039;,
			&#039;billing_last_name&#039;  =&gt; &#039;billing_last_name&#039;,
			&#039;billing_company&#039;    =&gt; &#039;billing_company&#039;,
			&#039;billing_address_1&#039;  =&gt; &#039;billing_address_1&#039;,
			&#039;billing_address_2&#039;  =&gt; &#039;billing_address_2&#039;,
			&#039;billing_city&#039;       =&gt; &#039;billing_city&#039;,
			&#039;billing_state&#039;      =&gt; &#039;billing_state&#039;,
			&#039;billing_postcode&#039;   =&gt; &#039;billing_postcode&#039;,
			&#039;billing_country&#039;    =&gt; &#039;billing_country&#039;,
			&#039;billing_email&#039;      =&gt; &#039;billing_email&#039;,
			&#039;billing_phone&#039;      =&gt; &#039;billing_phone&#039;,
		);

		foreach ( $billing_address_props as $meta_key =&gt; $prop ) {
			$prop_key = substr( $prop, 8 );

			if ( ! isset( $changed_props[&#039;billing&#039;] ) || ! array_key_exists( $prop_key, $changed_props[&#039;billing&#039;] ) ) {
				continue;
			}

			if ( update_user_meta( $customer-&gt;get_id(), $meta_key, $customer-&gt;{&quot;get_$prop&quot;}( &#039;edit&#039; ) ) ) {
				$updated_props[] = $prop;
			}
		}

		$shipping_address_props = array(
			&#039;shipping_first_name&#039; =&gt; &#039;shipping_first_name&#039;,
			&#039;shipping_last_name&#039;  =&gt; &#039;shipping_last_name&#039;,
			&#039;shipping_company&#039;    =&gt; &#039;shipping_company&#039;,
			&#039;shipping_address_1&#039;  =&gt; &#039;shipping_address_1&#039;,
			&#039;shipping_address_2&#039;  =&gt; &#039;shipping_address_2&#039;,
			&#039;shipping_city&#039;       =&gt; &#039;shipping_city&#039;,
			&#039;shipping_state&#039;      =&gt; &#039;shipping_state&#039;,
			&#039;shipping_postcode&#039;   =&gt; &#039;shipping_postcode&#039;,
			&#039;shipping_country&#039;    =&gt; &#039;shipping_country&#039;,
			&#039;shipping_phone&#039;      =&gt; &#039;shipping_phone&#039;,
		);

		foreach ( $shipping_address_props as $meta_key =&gt; $prop ) {
			$prop_key = substr( $prop, 9 );

			if ( ! isset( $changed_props[&#039;shipping&#039;] ) || ! array_key_exists( $prop_key, $changed_props[&#039;shipping&#039;] ) ) {
				continue;
			}

			if ( update_user_meta( $customer-&gt;get_id(), $meta_key, $customer-&gt;{&quot;get_$prop&quot;}( &#039;edit&#039; ) ) ) {
				$updated_props[] = $prop;
			}
		}

		do_action( &#039;woocommerce_customer_object_updated_props&#039;, $customer, $updated_props );
	}

	/**
	 * Check if the usage of the custom orders table is enabled.
	 *
	 * @return bool
	 */
	private function is_cot_in_use(): bool {
		return wc_get_container()-&gt;get( CustomOrdersTableController::class )-&gt;custom_orders_table_usage_is_enabled();
	}

	/**
	 * Gets the customers last order.
	 *
	 * @since 3.0.0
	 * @param WC_Customer $customer Customer object.
	 * @return WC_Order|false
	 */
	public function get_last_order( &amp;$customer ) {
		//phpcs:disable WooCommerce.Commenting.CommentHooks.MissingSinceComment
		/**
		 * Filters the id of the last order from a given customer.
		 *
		 * @param string @last_order_id The last order id as retrieved from the database.
		 * @param WC_Customer The customer whose last order id is being retrieved.
		 * @return string The actual last order id to use.
		 */
		$last_order_id = apply_filters(
			&#039;woocommerce_customer_get_last_order&#039;,
			get_user_meta( $customer-&gt;get_id(), &#039;_last_order&#039;, true ),
			$customer
		);
		//phpcs:enable WooCommerce.Commenting.CommentHooks.MissingSinceComment

		if ( &#039;&#039; === $last_order_id ) {
			global $wpdb;

			$order_statuses_sql = &quot;( &#039;&quot; . implode( &quot;&#039;,&#039;&quot;, array_map( &#039;esc_sql&#039;, array_keys( wc_get_order_statuses() ) ) ) . &quot;&#039; )&quot;;

			//phpcs:disable WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared
			if ( $this-&gt;is_cot_in_use() ) {
				$sql           = $wpdb-&gt;prepare(
					&#039;SELECT id FROM &#039; . OrdersTableDataStore::get_orders_table_name() . &quot;
					WHERE customer_id = %d
					AND status in $order_statuses_sql
					ORDER BY id DESC
					LIMIT 1&quot;,
					$customer-&gt;get_id()
				);
				$last_order_id = $wpdb-&gt;get_var( $sql );
			} else {
				$last_order_id = $wpdb-&gt;get_var(
					&quot;SELECT posts.ID
				FROM $wpdb-&gt;posts AS posts
				LEFT JOIN {$wpdb-&gt;postmeta} AS meta on posts.ID = meta.post_id
				WHERE meta.meta_key = &#039;_customer_user&#039;
				AND   meta.meta_value = &#039;&quot; . esc_sql( $customer-&gt;get_id() ) . &quot;&#039;
				AND   posts.post_type = &#039;shop_order&#039;
				AND   posts.post_status IN $order_statuses_sql
				ORDER BY posts.ID DESC
				LIMIT 1&quot;
				);
			}
			//phpcs:enable WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared
			update_user_meta( $customer-&gt;get_id(), &#039;_last_order&#039;, $last_order_id );
		}

		if ( ! $last_order_id ) {
			return false;
		}

		return wc_get_order( absint( $last_order_id ) );
	}

	/**
	 * Return the number of orders this customer has.
	 *
	 * @since 3.0.0
	 * @param WC_Customer $customer Customer object.
	 * @return integer
	 */
	public function get_order_count( &amp;$customer ) {
		$count = apply_filters(
			&#039;woocommerce_customer_get_order_count&#039;,
			get_user_meta( $customer-&gt;get_id(), &#039;_order_count&#039;, true ),
			$customer
		);

		$order_statuses_sql = &quot;( &#039;&quot; . implode( &quot;&#039;,&#039;&quot;, array_map( &#039;esc_sql&#039;, array_keys( wc_get_order_statuses() ) ) ) . &quot;&#039; )&quot;;

		if ( &#039;&#039; === $count ) {
			global $wpdb;

			//phpcs:disable WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared
			if ( $this-&gt;is_cot_in_use() ) {
				$sql   = $wpdb-&gt;prepare(
					&#039;SELECT COUNT(id) FROM &#039; . OrdersTableDataStore::get_orders_table_name() . &quot;
					WHERE customer_id = %d
					AND status in $order_statuses_sql&quot;,
					$customer-&gt;get_id()
				);
				$count = $wpdb-&gt;get_var( $sql );
			} else {
				$count = $wpdb-&gt;get_var(
					&quot;SELECT COUNT(*)
				FROM $wpdb-&gt;posts as posts
				LEFT JOIN {$wpdb-&gt;postmeta} AS meta ON posts.ID = meta.post_id
				WHERE   meta.meta_key = &#039;_customer_user&#039;
				AND     posts.post_type = &#039;shop_order&#039;
				AND     posts.post_status IN $order_statuses_sql
				AND     meta_value = &#039;&quot; . esc_sql( $customer-&gt;get_id() ) . &quot;&#039;&quot;
				);
			}
			//phpcs:enable WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared

			update_user_meta( $customer-&gt;get_id(), &#039;_order_count&#039;, $count );
		}

		return absint( $count );
	}

	/**
	 * Return how much money this customer has spent.
	 *
	 * @since 3.0.0
	 * @param WC_Customer $customer Customer object.
	 * @return float
	 */
	public function get_total_spent( &amp;$customer ) {
		$spent = apply_filters(
			&#039;woocommerce_customer_get_total_spent&#039;,
			get_user_meta( $customer-&gt;get_id(), &#039;_money_spent&#039;, true ),
			$customer
		);

		if ( &#039;&#039; === $spent ) {
			global $wpdb;

			$statuses     = array_map( &#039;esc_sql&#039;, wc_get_is_paid_statuses() );
			$statuses_sql = &quot;( &#039;wc-&quot; . implode( &quot;&#039;,&#039;wc-&quot;, $statuses ) . &quot;&#039; )&quot;;

			//phpcs:disable WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared
			if ( $this-&gt;is_cot_in_use() ) {
				$sql = $wpdb-&gt;prepare(
					&#039;SELECT SUM(total_amount) FROM &#039; . OrdersTableDataStore::get_orders_table_name() . &quot;
					WHERE customer_id = %d
					AND status in $statuses_sql&quot;,
					$customer-&gt;get_id()
				);
			} else {
				$sql = &quot;SELECT SUM(meta2.meta_value)
					FROM $wpdb-&gt;posts as posts
					LEFT JOIN {$wpdb-&gt;postmeta} AS meta ON posts.ID = meta.post_id
					LEFT JOIN {$wpdb-&gt;postmeta} AS meta2 ON posts.ID = meta2.post_id
					WHERE   meta.meta_key       = &#039;_customer_user&#039;
					AND     meta.meta_value     = &#039;&quot; . esc_sql( $customer-&gt;get_id() ) . &quot;&#039;
					AND     posts.post_type     = &#039;shop_order&#039;
					AND     posts.post_status   IN $statuses_sql
					AND     meta2.meta_key      = &#039;_order_total&#039;&quot;;
			}

			//phpcs:disable WooCommerce.Commenting.CommentHooks.MissingSinceComment
			/**
			 * Filters the SQL query used to get the combined total of all the orders from a given customer.
			 *
			 * @param string The SQL query to use.
			 * @param WC_Customer The customer to get the total spent for.
			 * @return string The actual SQL query to use.
			 */
			$sql = apply_filters( &#039;woocommerce_customer_get_total_spent_query&#039;, $sql, $customer );
			//phpcs:enable WooCommerce.Commenting.CommentHooks.MissingSinceComment

			$spent = $wpdb-&gt;get_var( $sql );
			//phpcs:enable WordPress.DB.PreparedSQL.NotPrepared, WordPress.DB.PreparedSQL.InterpolatedNotPrepared

			if ( ! $spent ) {
				$spent = 0;
			}
			update_user_meta( $customer-&gt;get_id(), &#039;_money_spent&#039;, $spent );
		}

		return wc_format_decimal( $spent, 2 );
	}

	/**
	 * Search customers and return customer IDs.
	 *
	 * @param  string     $term Search term.
	 * @param  int|string $limit Limit search results.
	 * @since 3.0.7
	 *
	 * @return array
	 */
	public function search_customers( $term, $limit = &#039;&#039; ) {
		$results = apply_filters( &#039;woocommerce_customer_pre_search_customers&#039;, false, $term, $limit );
		if ( is_array( $results ) ) {
			return $results;
		}

		$query = new WP_User_Query(
			apply_filters(
				&#039;woocommerce_customer_search_customers&#039;,
				array(
					&#039;search&#039;         =&gt; &#039;*&#039; . esc_attr( $term ) . &#039;*&#039;,
					&#039;search_columns&#039; =&gt; array( &#039;user_login&#039;, &#039;user_url&#039;, &#039;user_email&#039;, &#039;user_nicename&#039;, &#039;display_name&#039; ),
					&#039;fields&#039;         =&gt; &#039;ID&#039;,
					&#039;number&#039;         =&gt; $limit,
				),
				$term,
				$limit,
				&#039;main_query&#039;
			)
		);

		$query2 = new WP_User_Query(
			apply_filters(
				&#039;woocommerce_customer_search_customers&#039;,
				array(
					&#039;fields&#039;     =&gt; &#039;ID&#039;,
					&#039;number&#039;     =&gt; $limit,
					&#039;meta_query&#039; =&gt; array(
						&#039;relation&#039; =&gt; &#039;OR&#039;,
						array(
							&#039;key&#039;     =&gt; &#039;first_name&#039;,
							&#039;value&#039;   =&gt; $term,
							&#039;compare&#039; =&gt; &#039;LIKE&#039;,
						),
						array(
							&#039;key&#039;     =&gt; &#039;last_name&#039;,
							&#039;value&#039;   =&gt; $term,
							&#039;compare&#039; =&gt; &#039;LIKE&#039;,
						),
					),
				),
				$term,
				$limit,
				&#039;meta_query&#039;
			)
		);

		$results = wp_parse_id_list( array_merge( (array) $query-&gt;get_results(), (array) $query2-&gt;get_results() ) );

		if ( $limit &amp;&amp; count( $results ) &gt; $limit ) {
			$results = array_slice( $results, 0, $limit );
		}

		return $results;
	}

	/**
	 * Get all user ids who have `billing_email` set to any of the email passed in array.
	 *
	 * @param array $emails List of emails to check against.
	 *
	 * @return array
	 */
	public function get_user_ids_for_billing_email( $emails ) {
		$emails      = array_unique( array_map( &#039;strtolower&#039;, array_map( &#039;sanitize_email&#039;, $emails ) ) );
		$users_query = new WP_User_Query(
			array(
				&#039;fields&#039;     =&gt; &#039;ID&#039;,
				&#039;meta_query&#039; =&gt; array(
					array(
						&#039;key&#039;     =&gt; &#039;billing_email&#039;,
						&#039;value&#039;   =&gt; $emails,
						&#039;compare&#039; =&gt; &#039;IN&#039;,
					),
				),
			)
		);
		return array_unique( $users_query-&gt;get_results() );
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on August 24th, 2023 at 08:49 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1692866947"></script>
    <script src="../js/search.js?updated=1692866947"></script>
</body>
</html>
